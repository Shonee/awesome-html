<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>随机美女图片 - 极致美学（修复版）</title>
    <!-- NOTE: 将 typo 修正为 https:// -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="css/style.css" rel="stylesheet">
</head>

<style> 
    /* style.css - 终极修复版 v2 */
    :root {
        --bg-primary: #0a0a0a;
        --bg-secondary: #1a1a1a;
        --bg-card: rgba(255, 255, 255, 0.05);
        --accent: #ff6b6b;
        --accent-secondary: #4ecdc4;
        --accent-tertiary: #ffe66d;
        --text-primary: #ffffff;
        --text-secondary: #a0a0a0;
        --text-muted: #666666;
        --border: rgba(255, 255, 255, 0.1);
        --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        --shadow-colored: 0 25px 50px -12px rgba(255, 107, 107, 0.3);
        --gradient-main: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #ffe66d 100%);
        --gradient-card: linear-gradient(145deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        --blur: blur(20px);
    }

    [data-theme="light"] {
        --bg-primary: #f8fafc;
        --bg-secondary: #ffffff;
        --bg-card: rgba(255, 255, 255, 0.8);
        --text-primary: #1a202c;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --border: rgba(0, 0, 0, 0.1);
        --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
        --shadow-colored: 0 25px 50px -12px rgba(255, 107, 107, 0.2);
        --gradient-card: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.6) 100%);
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        overflow-x: hidden;
        transition: all 0.3s ease;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--gradient-main);
        opacity: 0.03;
        z-index: -2;
        animation: gradientShift 10s ease-in-out infinite;
    }

    @keyframes gradientShift {
        0%, 100% { transform: translateX(0) translateY(0) scale(1); }
        33% { transform: translateX(-20px) translateY(20px) scale(1.05); }
        66% { transform: translateX(20px) translateY(-20px) scale(0.95); }
    }

    .particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
    }

    .particle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: var(--accent);
        border-radius: 50%;
        opacity: 0.3;
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
        50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
    }

    .navbar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 80px;
        background: var(--bg-card);
        backdrop-filter: var(--blur);
        border-bottom: 1px solid var(--border);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 40px;
        transition: all 0.3s ease;
    }

    .logo {
        font-size: 24px;
        font-weight: 700;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .nav-actions {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .preload-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        margin-right: 15px;
        transition: all 0.3s ease;
    }

    .preload-indicator i {
        font-size: 16px;
        color: var(--accent);
    }

    .theme-toggle-btn {
        width: 50px;
        height: 26px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .theme-toggle-btn::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        background: var(--gradient-main);
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    [data-theme="light"] .theme-toggle-btn::after {
        transform: translateX(24px);
    }

    .container {
        padding: 120px 40px 40px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .hero-section {
        text-align: center;
        margin-bottom: 60px;
        position: relative;
    }

    .hero-title {
        font-size: clamp(3rem, 8vw, 6rem);
        font-weight: 700;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
        line-height: 1.1;
        letter-spacing: -2px;
        animation: slideInUp 1s ease-out;
    }

    .hero-subtitle {
        font-size: 18px;
        color: var(--text-secondary);
        font-weight: 400;
        animation: slideInUp 1s ease-out 0.2s both;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .main-content {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 40px;
        align-items: start;
    }

    .image-card {
        background: var(--gradient-card);
        border: 1px solid var(--border);
        border-radius: 32px;
        padding: 30px;
        backdrop-filter: var(--blur);
        box-shadow: var(--shadow);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }

    .image-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: var(--gradient-main);
        opacity: 0.6;
    }

    .image-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-colored);
    }

    .image-container {
        position: relative;
        border-radius: 24px;
        overflow: hidden;
        background: var(--bg-secondary);
        min-height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .image-container:hover {
        transform: scale(1.02);
    }

    #randomImage {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 24px;
        transition: all 0.5s ease;
        user-select: none;
        -webkit-user-drag: none;
    }

    .image-overlay {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 12px;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 5;
    }

    #imageContainer:hover .image-overlay {
        opacity: 1;
    }

    .overlay-btn {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: var(--blur);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all 0.3s ease;
    }

    .overlay-btn:hover {
        background: var(--accent);
        transform: scale(1.1);
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .btn {
        background: var(--gradient-main);
        color: white;
        border: none;
        padding: 18px 28px;
        border-radius: 20px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
    }

    .btn:active {
        transform: translateY(-1px);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }
    .btn:disabled::before {
        content: none; 
    }

    .btn-secondary {
        background: var(--bg-card);
        color: var(--text-primary);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:hover {
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary.small {
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 13px;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .sidebar-card {
        background: var(--gradient-card);
        border: 1px solid var(--border);
        border-radius: 24px;
        padding: 24px;
        backdrop-filter: var(--blur);
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
    }

    .sidebar-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-colored);
    }

    .sidebar-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar-title i {
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
    }

    .stat-item {
        text-align: center;
        padding: 20px 16px;
        background: var(--bg-secondary);
        border-radius: 16px;
        border: 1px solid var(--border);
        transition: all 0.3s ease;
    }

    .stat-item:hover {
        transform: translateY(-2px);
        background: var(--bg-card);
    }

    .stat-number {
        font-size: 28px;
        font-weight: 700;
        background: var(--gradient-main);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 500;
    }

    .content-list {
        max-height: 200px;
        overflow-y: auto;
    }

    .content-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        margin-bottom: 8px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.12s ease;
    }

    .content-item:hover {
        background: var(--bg-card);
    }

    .content-thumb {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        object-fit: cover;
    }

    .content-info {
        flex: 1;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .remove-btn {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        background: var(--accent);
        color: white;
        border: none;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0.7;
        transition: all 0.3s ease;
    }

    .remove-btn:hover {
        opacity: 1;
        transform: scale(1.1);
    }

    .quality-selector {
        display: flex;
        gap: 8px;
    }

    .quality-btn {
        flex: 1;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        font-weight: 500;
    }

    .quality-btn.active,
    .quality-btn:hover {
        background: var(--gradient-main);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
    }

    .quality-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: var(--bg-secondary);
        color: var(--text-muted);
        transform: none;
    }

    .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 18px;
        color: var(--text-secondary);
        animation: loadingPulse 2s infinite;
        z-index: 2;
        display: none;
    }

    @keyframes loadingPulse {
        0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
    }

    .error-msg {
        display: none;
        margin-top: 20px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    .fullscreen-overlay {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.95);
        backdrop-filter: var(--blur);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.18s ease-out;
    }

    .fullscreen-inner {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        box-sizing: border-box;
        overflow: auto;
    }

    .fullscreen-image {
        max-width: calc(100% - 80px);
        max-height: calc(100% - 80px);
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        user-select: none;
        -webkit-user-drag: none;
    }

    .fullscreen-close {
        position: absolute;
        top: 24px;
        right: 24px;
        z-index: 2100;
        width: 56px;
        height: 56px;
        border-radius: 12px;
        background: rgba(255,255,255,0.08);
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .fullscreen-close:hover {
        background: var(--accent);
        transform: scale(1.03);
    }

    .share-panel {
        position: fixed;
        bottom: -300px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 480px;
        background: var(--gradient-card);
        backdrop-filter: var(--blur);
        border: 1px solid var(--border);
        border-radius: 24px 24px 0 0;
        padding: 30px;
        box-shadow: var(--shadow);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1500;
    }

    .share-panel.active {
        bottom: 0;
    }

    .share-title {
        text-align: center;
        margin-bottom: 24px;
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .share-options {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .share-btn {
        padding: 20px 16px;
        border-radius: 16px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        font-weight: 500;
        color: white;
    }

    .share-btn i {
        font-size: 24px;
    }

    .share-btn.weibo { background: linear-gradient(135deg, #ff6b6b, #ee5a52); }
    .share-btn.weixin { background: linear-gradient(135deg, #4ecdc4, #44b3ab); }
    .share-btn.qq { background: linear-gradient(135deg, #3498db, #2980b9); }
    .share-btn.link { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

    .share-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }

    .cancel-btn {
        width: 100%;
        padding: 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 16px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .cancel-btn:hover {
        background: var(--bg-card);
        color: var(--text-primary);
    }

    .notification {
        position: fixed;
        top: 100px;
        right: 40px;
        background: var(--gradient-card);
        backdrop-filter: var(--blur);
        border: 1px solid var(--border);
        color: var(--text-primary);
        padding: 12px 18px;
        border-radius: 16px;
        box-shadow: var(--shadow);
        z-index: 1000;
        transform: translateX(400px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 500;
        pointer-events: none;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification .notification-thumb {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        object-fit: cover;
        margin-left: 10px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        flex-shrink: 0;
    }

    .management-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    }

    .management-options .btn-secondary.small {
        width: auto;
        text-align: center;
        white-space: nowrap;
    }

    @media (max-width: 1024px) {
        .main-content {
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .sidebar {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: auto;
            display: grid;
        }
    }

    @media (max-width: 768px) {
        .navbar {
            padding: 0 20px;
        }
        .nav-actions {
            gap: 10px;
        }
        .preload-indicator {
            margin-right: 5px;
            padding: 6px 10px;
            font-size: 12px;
        }
        .preload-indicator i {
            font-size: 14px;
        }
        .container {
            padding: 100px 20px 20px;
        }
        .sidebar {
            grid-template-columns: 1fr;
            display: flex;
        }
        .controls {
            grid-template-columns: 1fr;
        }
        .notification {
            top: 20px;
            right: 20px;
            left: 20px;
            max-width: unset;
            transform: translateX(calc(100% + 40px));
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .hero-title {
            font-size: 2.5rem;
        }
        .image-card {
            padding: 20px;
        }
        .sidebar-card {
            padding: 16px;
        }
    }

    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--gradient-main);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--accent);
    }

</style>

<body data-theme="dark">
    <div class="particles" id="particles"></div>

    <nav class="navbar">
        <div class="logo">
            <i class="fas fa-images"></i> RandomBeauty
        </div>
        <div class="nav-actions">
            <!-- 预加载指示器，用于显示下一张图片正在加载的状态 -->
            <div class="preload-indicator" id="preloadIndicator" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <span>预加载中...</span>
            </div>
            <div class="theme-toggle-btn" onclick="toggleTheme()" title="切换主题"></div>
        </div>
    </nav>

    <div class="container">
        <div class="hero-section">
            <h1 class="hero-title">随机美女图片</h1>
            <p class="hero-subtitle">发现每一刻的美好，感受视觉的极致体验</p>
        </div>

        <div class="main-content">
            <div class="image-card">
                <div class="image-container" id="imageContainer">
                    <img id="randomImage" src="" alt="随机美女图片" style="display: none;">
                    <div class="loading" id="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div>正在加载精美图片...</div>
                    </div>

                    <div class="image-overlay">
                        <button class="overlay-btn" onclick="event.stopPropagation(); toggleFavorite()" title="收藏">
                            <i id="favoriteIcon" class="far fa-heart"></i>
                        </button>
                        <button class="overlay-btn" onclick="event.stopPropagation(); showSharePanel()" title="分享">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="overlay-btn" onclick="event.stopPropagation(); openFullscreen()" title="全屏">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn" onclick="loadRandomImage()" id="loadBtn">
                        <i class="fas fa-dice"></i>
                        <span>换一张</span>
                    </button>
                    <button class="btn btn-secondary" onclick="downloadImage()" id="downloadBtn">
                        <i class="fas fa-download"></i>
                        <span>下载</span>
                    </button>
                    <button class="btn btn-secondary" onclick="toggleFavorite()" id="favoriteBtn">
                        <i class="far fa-heart"></i>
                        <span>收藏</span>
                    </button>
                    <button class="btn btn-secondary" onclick="showSharePanel()" id="shareBtn">
                        <i class="fas fa-share-alt"></i>
                        <span>分享</span>
                    </button>
                </div>

                <div class="error-msg" id="errorMsg">
                    <i class="fas fa-exclamation-triangle"></i>
                    图片加载失败，请检查网络连接或稍后重试
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-chart-bar"></i>
                        数据统计
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-number" id="viewCount">0</div>
                            <div class="stat-label">浏览次数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="favoriteCount">0</div>
                            <div class="stat-label">收藏数量</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="downloadCount">0</div>
                            <div class="stat-label">下载次数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="shareCount">0</div>
                            <div class="stat-label">分享次数</div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-cog"></i>
                        图片质量
                    </div>
                    <div class="quality-selector">
                        <button class="quality-btn active" data-quality="original">原图</button>
                        <button class="quality-btn" data-quality="high">高清</button>
                        <button class="quality-btn" data-quality="medium">标准</button>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-heart"></i>
                        我的收藏
                    </div>
                    <div class="content-list" id="favoritesList">
                        <div style="text-align: center; color: var(--text-muted); padding: 30px 20px;">
                            <i class="far fa-heart" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            暂无收藏
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-history"></i>
                        浏览历史
                    </div>
                    <div class="content-list" id="historyList">
                        <div style="text-align: center; color: var(--text-muted); padding: 30px 20px;">
                            <i class="fas fa-history" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                            暂无历史
                        </div>
                    </div>
                </div>

                <div class="sidebar-card">
                    <div class="sidebar-title">
                        <i class="fas fa-tools"></i>
                        管理选项
                    </div>
                    <div class="management-options">
                        <button class="btn-secondary small" onclick="clearHistory()">清空浏览历史</button>
                        <button class="btn-secondary small" onclick="clearFavorites()">清空我的收藏</button>
                        <button class="btn-secondary small" onclick="clearCache()">清空缓存图片</button>
                        <button class="btn-secondary small" onclick="clearStats()">清空统计数据</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 全屏覆盖（点击遮罩或关闭按钮或按 Esc 均可退出） -->
    <div class="fullscreen-overlay" id="fullscreenOverlay" aria-hidden="true">
        <div class="fullscreen-inner" id="fullscreenInner" role="dialog" aria-modal="true">
            <img class="fullscreen-image" id="fullscreenImage" src="" alt="全屏图片">
            <button class="fullscreen-close" id="fullscreenClose" aria-label="关闭全屏">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="share-panel" id="sharePanel" aria-hidden="true">
        <h3 class="share-title">分享到</h3>
        <div class="share-options">
            <button class="share-btn weibo" onclick="shareToWeibo()">
                <i class="fab fa-weibo"></i>
                微博
            </button>
            <button class="share-btn weixin" onclick="shareToWeixin()">
                <i class="fab fa-weixin"></i>
                微信
            </button>
            <button class="share-btn qq" onclick="shareToQQ()">
                <i class="fab fa-qq"></i>
                QQ
            </button>
            <button class="share-btn link" onclick="copyLink()">
                <i class="fas fa-link"></i>
                复制链接
            </button>
        </div>
        <button class="cancel-btn" onclick="hideSharePanel()">取消</button>
    </div>

    <!-- <script src="js/script.js"></script> -->
</body>
<script> 
    // js/script.js - 终极修复版 v4 (修复下载按钮闪烁问题)

    // 默认示例 API。
    const API_URL = 'https://api.jkyai.top/API/sjmtzs.php';

    // ----- IndexedDB 简单封装 -----
    const DB_NAME = 'random_beauty_db';
    const DB_VERSION = 1;
    const STORE_IMAGES = 'images';

    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = function(e) {
                const db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_IMAGES)) {
                    const store = db.createObjectStore(STORE_IMAGES, { keyPath: 'id' });
                    store.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
            req.onsuccess = function(e) {
                resolve(e.target.result);
            };
            req.onerror = function(e) {
                reject(e.target.error);
            };
        });
    }

    async function dbPutImage(record) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_IMAGES, 'readwrite');
            const store = tx.objectStore(STORE_IMAGES);
            const req = store.put(record);
            req.onsuccess = () => resolve(true);
            req.onerror = (e) => reject(e.target.error);
        });
    }

    async function dbGetImage(id) {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_IMAGES, 'readonly');
            const store = tx.objectStore(STORE_IMAGES);
            const req = store.get(id);
            req.onsuccess = () => resolve(req.result);
            req.onerror = (e) => reject(e.target.error);
        });
    }

    async function dbClearAllImages() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_IMAGES, 'readwrite');
            const store = tx.objectStore(STORE_IMAGES);
            const req = store.clear();
            req.onsuccess = () => resolve(true);
            req.onerror = (e) => reject(e.target.error);
        });
    }


    // ----- 状态与 DOM -----
    const state = {
        currentImageId: localStorage.getItem('lastImageId') || '',
        currentImageUrl: '',
        favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
        history: JSON.parse(localStorage.getItem('history') || '[]'),
        stats: JSON.parse(localStorage.getItem('stats') || '{"views":0,"downloads":0,"shares":0}'),
        theme: localStorage.getItem('theme') || 'dark',
        quality: localStorage.getItem('quality') || 'original',
        preloadedImage: null,
        isPreloading: false,
        isLoadingMainImage: false,
        currentPreloadSessionId: null
    };

    const elements = {
        image: document.getElementById('randomImage'),
        loading: document.getElementById('loading'),
        error: document.getElementById('errorMsg'),
        loadBtn: document.getElementById('loadBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        favoriteBtn: document.getElementById('favoriteBtn'),
        favoriteIcon: document.getElementById('favoriteIcon'),
        fullscreenOverlay: document.getElementById('fullscreenOverlay'),
        fullscreenInner: document.getElementById('fullscreenInner'),
        fullscreenImage: document.getElementById('fullscreenImage'),
        fullscreenClose: document.getElementById('fullscreenClose'),
        sharePanel: document.getElementById('sharePanel'),
        favoritesList: document.getElementById('favoritesList'),
        historyList: document.getElementById('historyList'),
        viewCount: document.getElementById('viewCount'),
        favoriteCount: document.getElementById('favoriteCount'),
        downloadCount: document.getElementById('downloadCount'),
        shareCount: document.getElementById('shareCount'),
        preloadIndicator: document.getElementById('preloadIndicator')
    };

    let currentObjectUrl = null;

    // ----- 初始化 -----
    async function init() {
        createParticles();
        applyTheme();
        loadStats();
        loadFavorites();
        loadHistory();
        setupQualitySelector();
        setupFullscreenHandlers();

        document.querySelectorAll('.quality-btn').forEach(btn => {
            if (btn.getAttribute('data-quality') === state.quality) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        try {
            if (state.currentImageId) {
                const record = await dbGetImage(state.currentImageId);
                if (record && record.blob) {
                    console.log("Found lastImageId in cache, displaying...");
                    await fetchAndDisplayImage(
                        () => Promise.resolve({
                            id: state.currentImageId,
                            blob: record.blob,
                            sourceUrl: record.sourceUrl
                        }),
                        false // Don't show loading for cached images
                    );
                } else {
                    await fetchAndDisplayNewImage();
                }
            } else {
                await fetchAndDisplayNewImage();
            }
        } catch (err) {
            console.error('Initial image loading failed:', err);
            showNotification(`初始化加载图片失败: ${err.message}`, 'fas fa-exclamation-triangle');
            showError();
        }
    }

    /**
     * 通用的图片获取与显示流程控制器
     * @param {Function} imageFetchFn - 一个返回 {id, blob, sourceUrl} 的 Promise 函数
     * @param {boolean} [showMainLoading=true] - 是否显示主加载动画
     * @returns {Promise<void>}
     */
    async function fetchAndDisplayImage(imageFetchFn, showMainLoading = true) {
        if (state.isLoadingMainImage) {
            console.warn("fetchAndDisplayImage called while another is in progress. Aborting.");
            return;
        }
        state.isLoadingMainImage = true;
        if (showMainLoading) {
            showLoading();
        }
        elements.error.style.display = 'none';

        try {
            const imageData = await imageFetchFn();
            await displayAndProcessImage(imageData);

            // 图片成功显示后，立即开始预加载下一张
            triggerPreload();

        } catch (err) {
            console.error('Failed to fetch and display image:', err);
            showError();
            showNotification(`加载图片失败: ${err.message}`, 'fas fa-exclamation-triangle');
        } finally {
            state.isLoadingMainImage = false;
            if (showMainLoading) {
                hideLoading();
            }
        }
    }


    /**
     * 核心函数：显示图片到主区域并处理相关逻辑
     * @param {Object} imageData - 包含 id, blob, sourceUrl 的图片数据对象
     */
    async function displayAndProcessImage(imageData) {
        if (currentObjectUrl) {
            try { URL.revokeObjectURL(currentObjectUrl); } catch (e) { /* silent error */ }
        }
        const objUrl = URL.createObjectURL(imageData.blob);
        currentObjectUrl = objUrl;

        elements.image.src = objUrl;
        elements.image.style.display = 'block';

        await new Promise((resolve, reject) => {
            const img = elements.image;
            const loadHandler = () => {
                img.removeEventListener('load', loadHandler);
                img.removeEventListener('error', errorHandler);
                requestAnimationFrame(() => requestAnimationFrame(resolve));
            };
            const errorHandler = (e) => {
                img.removeEventListener('load', loadHandler);
                img.removeEventListener('error', errorHandler);
                reject(new Error('主图片元素加载失败或无法显示。', { cause: e }));
            };
            img.addEventListener('load', loadHandler);
            img.addEventListener('error', errorHandler);
            if (img.complete && img.naturalHeight !== 0 && img.src === objUrl) {
                requestAnimationFrame(() => requestAnimationFrame(resolve));
            }
        });

        state.currentImageId = imageData.id;
        state.currentImageUrl = imageData.sourceUrl;
        localStorage.setItem('lastImageId', imageData.id);

        hideLoading();

        addToHistory({ id: imageData.id, url: imageData.sourceUrl });
        updateStats('views');
        updateFavoriteButton();
        console.log(`Current image (ID: ${imageData.id}) displayed successfully.`);
    }

    function triggerPreload() {
        preloadNextImage().then(() => {
            if (state.preloadedImage && state.preloadedImage.isReady && !state.isLoadingMainImage) {
                showNotification('下一张图片已预加载', 'fas fa-sync', state.preloadedImage.objUrl);
            }
        });
    }

    function fetchAndDisplayNewImage() {
        return fetchAndDisplayImage(() => {
            const requestUrl = API_URL + '?t=' + Date.now() + '&quality=' + encodeURIComponent(state.quality);
            return loadImageToBlob(requestUrl).then(async ({ blob, id, timestamp }) => {
                await dbPutImage({ id, blob, timestamp, sourceUrl: requestUrl });
                return { blob, id, sourceUrl: requestUrl };
            });
        });
    }


    // ----- 粒子背景 -----
    function createParticles() {
        const particlesContainer = document.getElementById('particles');
        if (!particlesContainer) return;
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 6 + 's';
            particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
            particlesContainer.appendChild(particle);
        }
    }

    // ----- 显示/隐藏状态 -----
    function showLoading() {
        elements.loading.style.display = 'block';
        elements.image.style.display = 'none';
        elements.loadBtn.disabled = true;
        elements.downloadBtn.disabled = true;
        elements.favoriteBtn.disabled = true;
    }

    function hideLoading() {
        elements.loading.style.display = 'none';
        elements.loadBtn.disabled = false;
        elements.downloadBtn.disabled = false;
        elements.favoriteBtn.disabled = false;
    }

    function showError() {
        elements.error.style.display = 'block';
        elements.image.style.display = 'none';
        hideLoading();
    }

    let notificationTimeoutId = null;
    function showNotification(message, iconClass, imageUrl = null) {
        if (notificationTimeoutId) {
            clearTimeout(notificationTimeoutId);
            notificationTimeoutId = null;
        }
        document.querySelectorAll('.notification').forEach(oldNotification => {
            const oldThumb = oldNotification.querySelector('.notification-thumb');
            if (oldThumb && oldThumb.src.startsWith('blob:')) {
                try { URL.revokeObjectURL(oldThumb.src); } catch (e) { }
            }
            oldNotification.remove();
        });
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.innerHTML = `
            <i class="${iconClass}"></i>
            <span>${message}</span>
            ${imageUrl ? `<img src="${imageUrl}" class="notification-thumb" alt="预览">` : ''}
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.classList.add('show'), 100);
        notificationTimeoutId = setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentElement) {
                    document.body.removeChild(notification);
                    if (imageUrl && imageUrl.startsWith('blob:')) {
                        try { URL.revokeObjectURL(imageUrl); } catch (e) { }
                    }
                }
                notificationTimeoutId = null;
            }, 400);
        }, 3000);
    }

    // ----- 生成唯一 ID -----
    function genId() {
        return 'img_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
    }

    async function loadImageToBlob(url, maxRetries = 2) {
        console.log("Attempting to load image to Blob from:", url);
        let attempt = 0;
        while (attempt <= maxRetries) {
            try {
                const image = new Image();
                image.crossOrigin = 'anonymous';
                image.src = url;

                await new Promise((resolve, reject) => {
                    const timeout = 15000;
                    const timer = setTimeout(() => reject(new Error('图片元素加载超时。')), timeout);
                    image.onload = () => { clearTimeout(timer); resolve(); };
                    image.onerror = (e) => { clearTimeout(timer); reject(new Error(`图片加载元素失败 (尝试 ${attempt + 1}/${maxRetries + 1})`)); };
                });

                await image.decode();

                const canvas = document.createElement('canvas');
                canvas.width = image.naturalWidth;
                canvas.height = image.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0);

                const blob = await new Promise((resolve, reject) => {
                    canvas.toBlob(b => b ? resolve(b) : reject(new Error('无法从 Canvas 获取图片 Blob 数据。')), 'image/jpeg', 0.9);
                });
                console.log(`Image loaded to Blob successfully on attempt ${attempt + 1}.`);
                return { blob, id: genId(), timestamp: Date.now() };

            } catch (err) {
                console.warn(`loadImageToBlob failed on attempt ${attempt + 1}:`, err.message);
                attempt++;
                if (attempt > maxRetries) throw new Error(`图片加载失败，已达最大重试次数 (${maxRetries + 1})。`, { cause: err });
                await new Promise(res => setTimeout(res, 500 * attempt));
            }
        }
    }

    // ----- 预加载下一张图片 -----
    async function preloadNextImage() {
        if (state.isPreloading) {
            console.log("Skipping preload: another preload is already running.");
            return;
        }

        state.isPreloading = true;
        const thisPreloadSessionId = Date.now();
        state.currentPreloadSessionId = thisPreloadSessionId;

        elements.preloadIndicator.style.display = 'flex';

        if (state.preloadedImage && state.preloadedImage.objUrl) {
            try { URL.revokeObjectURL(state.preloadedImage.objUrl); } catch (e) { /* ignore */ }
        }
        state.preloadedImage = null;

        try {
            const preloadUrl = API_URL + '?t=' + Date.now() + '&quality=' + encodeURIComponent(state.quality);
            console.log(`Starting preload for session: ${thisPreloadSessionId}`);
            const { blob, id, timestamp } = await loadImageToBlob(preloadUrl);

            if (state.currentPreloadSessionId !== thisPreloadSessionId) {
                console.log(`Aborting preload session ${thisPreloadSessionId}: a new one has started.`);
                return;
            }

            await dbPutImage({ id, blob, timestamp, sourceUrl: preloadUrl });
            const objUrl = URL.createObjectURL(blob);

            state.preloadedImage = { id, blob, sourceUrl: preloadUrl, objUrl, isReady: true };
            console.log(`Preload session ${thisPreloadSessionId} completed successfully.`);

        } catch (err) {
            console.error(`Preload session ${thisPreloadSessionId} failed:`, err);
            if (state.currentPreloadSessionId === thisPreloadSessionId) {
                state.preloadedImage = null;
            }
        } finally {
            if (state.currentPreloadSessionId === thisPreloadSessionId) {
                state.isPreloading = false;
                elements.preloadIndicator.style.display = 'none';
            }
        }
    }

    // ----- 加载随机图片 -----
    async function loadRandomImage() {
        if (state.isLoadingMainImage) {
            console.log("Main image is already loading, skipping loadRandomImage call.");
            return;
        }

        state.currentPreloadSessionId = null;
        state.isPreloading = false;
        elements.preloadIndicator.style.display = 'none';

        if (state.preloadedImage && state.preloadedImage.isReady) {
            console.log("Using preloaded image:", state.preloadedImage.id);
            const preloadedData = state.preloadedImage;
            state.preloadedImage = null;

            await fetchAndDisplayImage(() => Promise.resolve(preloadedData), false);
        } else {
            console.log("No valid preloaded image available, fetching a new one directly.");
            await fetchAndDisplayNewImage();
        }
    }


    // ----- 全屏 -----
    let fullscreenImageObjectUrl = null;

    function setupFullscreenHandlers() {
        elements.fullscreenOverlay.addEventListener('click', (e) => {
            if (!elements.fullscreenInner.contains(e.target)) {
                exitFullscreen();
            }
        });

        elements.fullscreenClose.addEventListener('click', (e) => {
            e.stopPropagation();
            exitFullscreen();
        });

        elements.fullscreenImage.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }

    function openFullscreen() {
        enterFullscreen();
    }

    function enterFullscreen() {
        if (!state.currentImageId) {
            showNotification('请先加载一张图片', 'fas fa-exclamation-triangle');
            return;
        }

        dbGetImage(state.currentImageId).then(rec => {
            if (!rec || !rec.blob) {
                showNotification('无法进入全屏：图片未缓存或已失效', 'fas fa-exclamation-triangle');
                return;
            }
            if (fullscreenImageObjectUrl) {
                try { URL.revokeObjectURL(fullscreenImageObjectUrl); } catch (e) { }
                fullscreenImageObjectUrl = null;
            }
            fullscreenImageObjectUrl = URL.createObjectURL(rec.blob);
            elements.fullscreenImage.src = fullscreenImageObjectUrl;
            elements.fullscreenOverlay.style.display = 'flex';
            elements.fullscreenOverlay.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            document.addEventListener('keydown', handleFullscreenKeydown, { capture: true });
            setTimeout(() => elements.fullscreenClose.focus(), 0);
        }).catch(err => {
            console.error('enterFullscreen error', err);
            showNotification('进入全屏失败', 'fas fa-exclamation-triangle');
        });
    }

    function exitFullscreen() {
        elements.fullscreenOverlay.style.display = 'none';
        elements.fullscreenOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        document.removeEventListener('keydown', handleFullscreenKeydown, { capture: true });
        try {
            if (fullscreenImageObjectUrl) {
                URL.revokeObjectURL(fullscreenImageObjectUrl);
                fullscreenImageObjectUrl = null;
            }
        } catch (e) {
            console.warn('Error revoke fullscreen URL', e);
        }
        elements.fullscreenImage.src = '';
    }

    function handleFullscreenKeydown(e) {
        const overlayVisible = elements.fullscreenOverlay.style.display === 'flex';
        if (!overlayVisible) return;

        if (e.key === 'Escape' || e.key === 'Esc') {
            e.preventDefault();
            exitFullscreen();
            return;
        }
        if (e.key === 'ArrowRight' || e.key === ' ') {
            e.preventDefault();
            loadRandomImage();
            return;
        }
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            if (state.history && state.history.length > 0) {
                let prevImageId = null;
                const currentHistoryIndex = state.history.findIndex(item => item.id === state.currentImageId);
                if (currentHistoryIndex !== -1 && (currentHistoryIndex + 1) < state.history.length) {
                    prevImageId = state.history[currentHistoryIndex + 1].id;
                }
                if (prevImageId && prevImageId !== state.currentImageId) {
                    loadImageFromHistory(prevImageId);
                } else {
                    showNotification('没有更早的浏览历史了', 'fas fa-info-circle');
                }
            } else {
                showNotification('没有浏览历史可供回退', 'fas fa-info-circle');
            }
        }
    }

    // ----- 收藏 -----
    function toggleFavorite() {
        if (!state.currentImageId) {
            showNotification('请先加载一张图片才能收藏', 'fas fa-info-circle');
            return;
        }
        const existIndex = state.favorites.findIndex(f => f.id === state.currentImageId);
        if (existIndex !== -1) {
            state.favorites.splice(existIndex, 1);
            showNotification('已取消收藏', 'fas fa-heart-broken');
        } else {
            const item = { id: state.currentImageId, url: state.currentImageUrl, timestamp: new Date().toLocaleString() };
            state.favorites.unshift(item);
            showNotification('收藏成功', 'fas fa-heart');
        }
        state.favorites = state.favorites.slice(0, 100);
        localStorage.setItem('favorites', JSON.stringify(state.favorites));
        loadFavorites();
        updateFavoriteButton();
        updateStats('favorites');
    }

    function updateFavoriteButton() {
        const isFavorited = state.favorites.some(f => f.id === state.currentImageId);
        elements.favoriteIcon.className = isFavorited ? 'fas fa-heart' : 'far fa-heart';
        elements.favoriteBtn.innerHTML = `<i class="${isFavorited ? 'fas' : 'far'} fa-heart"></i><span>${isFavorited ? '已收藏' : '收藏'}</span>`;
    }

    async function loadFavorites() {
        const container = elements.favoritesList;
        if (!state.favorites || state.favorites.length === 0) {
            container.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 30px 20px;"><i class="far fa-heart" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>暂无收藏</div>`;
            elements.favoriteCount.textContent = 0;
            return;
        }
        const rows = await Promise.all(state.favorites.slice(0, 50).map(async fav => {
            const rec = await dbGetImage(fav.id);
            let thumbUrl = '';
            if (rec && rec.blob) {
                try { thumbUrl = URL.createObjectURL(rec.blob); } catch (e) { thumbUrl = ''; }
            } else {
                if (fav.url) { thumbUrl = fav.url; }
            }
            return `<div class="content-item" onclick="loadImageFromFavorite('${fav.id}');"><img class="content-thumb" src="${thumbUrl}" alt="收藏图片" loading="lazy"><div class="content-info">${fav.timestamp}</div><button class="remove-btn" onclick="event.stopPropagation(); removeFavorite('${fav.id}')"><i class="fas fa-times"></i></button></div>`;
        }));
        container.innerHTML = rows.join('') || '<div style="text-align:center;color:var(--text-muted);padding:30px 20px;">暂无收藏</div>';
        elements.favoriteCount.textContent = state.favorites.length;
    }

    async function loadImageFromId(id, isFavorite = true) {
        if (state.isLoadingMainImage) {
            console.log("Main image is already loading, skipping loadImageFromId call.");
            return;
        }
        const imageFetchFn = async () => {
            let rec = await dbGetImage(id);
            if (rec && rec.blob) {
                return { id: rec.id, blob: rec.blob, sourceUrl: rec.sourceUrl || '' };
            }
            const item = (isFavorite ? state.favorites : state.history).find(f => f.id === id);
            if (!item || !item.url) throw new Error(`${isFavorite ? '收藏' : '历史'}元数据丢失图片地址`);
            const { blob, id: newId, timestamp } = await loadImageToBlob(item.url);
            await dbPutImage({ id: newId, blob, timestamp, sourceUrl: item.url });
            showNotification('图片已从远程加载并缓存', 'fas fa-check-circle');
            return { id: newId, blob, sourceUrl: item.url };
        };
        fetchAndDisplayImage(imageFetchFn);
    }

    function loadImageFromFavorite(id) {
        return loadImageFromId(id, true);
    }

    function loadImageFromHistory(id) {
        return loadImageFromId(id, false);
    }

    function removeFavorite(id) {
        state.favorites = state.favorites.filter(f => f.id !== id);
        const favItem = elements.favoritesList.querySelector(`[onclick*="loadImageFromFavorite('${id}')"] .content-thumb`);
        if (favItem && favItem.src.startsWith('blob:')) {
            try { URL.revokeObjectURL(favItem.src); } catch (e) { }
        }
        localStorage.setItem('favorites', JSON.stringify(state.favorites));
        loadFavorites();
        updateStats('favorites');
        showNotification('已移除收藏', 'fas fa-times');
    }

    // ----- 分享 -----
    function showSharePanel() {
        if (!state.currentImageId) {
            showNotification('请先加载一张图片才能分享', 'fas fa-info-circle');
            return;
        }
        elements.loadBtn.disabled = true;
        elements.downloadBtn.disabled = true;
        elements.favoriteBtn.disabled = true;
        elements.sharePanel.classList.add('active');
        elements.sharePanel.setAttribute('aria-hidden', 'false');
        setTimeout(() => {
            const firstFocusable = elements.sharePanel.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) firstFocusable.focus();
        }, 100);
    }

    function hideSharePanel() {
        elements.sharePanel.classList.remove('active');
        elements.sharePanel.setAttribute('aria-hidden', 'true');
        elements.loadBtn.disabled = false;
        elements.downloadBtn.disabled = false;
        elements.favoriteBtn.disabled = false;
        document.activeElement?.blur();
        elements.shareBtn.focus();
    }

    async function shareToWeibo() {
        const shareUrl = state.currentImageUrl || '';
        const text = encodeURIComponent('发现一张超美的图片！快来看看吧！');
        if (shareUrl) {
            window.open(`https://service.weibo.com/share/share.php?url=${encodeURIComponent(shareUrl)}&title=${text}`, '_blank');
            updateStats('shares');
            hideSharePanel();
        } else {
            showNotification('无法获取图片链接分享', 'fas fa-exclamation-triangle');
        }
    }

    function shareToWeixin() {
        copyLink();
        showNotification('链接已复制，请在微信中粘贴分享', 'fab fa-weixin');
        hideSharePanel();
    }

    async function shareToQQ() {
        const shareUrl = state.currentImageUrl || '';
        const text = encodeURIComponent('发现一张超美的图片！快来看看吧！');
        if (shareUrl) {
            window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(shareUrl)}&title=${text}`, '_blank');
            updateStats('shares');
            hideSharePanel();
        } else {
            showNotification('无法获取图片链接分享', 'fas fa-exclamation-triangle');
        }
    }

    function copyLink() {
        const url = state.currentImageUrl || '';
        if (!url) {
            showNotification('当前没有图片链接可复制', 'fas fa-exclamation-triangle');
            return;
        }
        navigator.clipboard.writeText(url).then(() => {
            showNotification('图片链接已复制到剪贴板', 'fas fa-link');
            updateStats('shares');
        }).catch(err => {
            console.error('复制链接失败：', err);
            showNotification('复制失败，请手动复制', 'fas fa-exclamation-triangle');
        });
    }

    // ----- 主题 -----
    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', state.theme);
        applyTheme();
    }

    function applyTheme() {
        document.body.setAttribute('data-theme', state.theme);
    }

    // ----- 质量 -----
    function setupQualitySelector() {
        document.querySelectorAll('.quality-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (state.isLoadingMainImage || state.isPreloading) {
                    showNotification('图片正在加载或预加载中，请稍后再切换质量。', 'fas fa-info-circle');
                    return;
                }
                document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const newQuality = btn.getAttribute('data-quality');
                if (state.quality !== newQuality) {
                    state.quality = newQuality;
                    localStorage.setItem('quality', state.quality);
                    showNotification(`图片质量已设置为：${btn.textContent}`, 'fas fa-check-circle');
                    state.currentPreloadSessionId = null;
                    if (state.preloadedImage && state.preloadedImage.objUrl) {
                        try { URL.revokeObjectURL(state.preloadedImage.objUrl); } catch (e) { }
                    }
                    state.preloadedImage = null;
                    state.isPreloading = false;
                    await fetchAndDisplayNewImage();
                }
            });
        });
    }

    // ----- 下载 (核心修改，消除闪烁) -----
    async function downloadImage() {
        if (!state.currentImageId) {
            showNotification('请先加载一张图片', 'fas fa-exclamation-triangle');
            return;
        }
        if (elements.downloadBtn.disabled) {
            return;
        }

        const originalBtnContent = elements.downloadBtn.innerHTML;
        elements.downloadBtn.disabled = true;
        elements.downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> <span>下载中...</span>`;

        try {
            const rec = await dbGetImage(state.currentImageId);
            let blobToDownload = null;
            if (!rec || !rec.blob) {
                showNotification('当前图片未缓存，正在重新加载后下载...', 'fas fa-info-circle');
                const imgUrl = state.currentImageUrl;
                if (!imgUrl) {
                    throw new Error('当前图片URL未知，无法重新加载下载。');
                }
                const { blob } = await loadImageToBlob(imgUrl);
                await dbPutImage({ id: state.currentImageId, blob, timestamp: Date.now(), sourceUrl: imgUrl });
                blobToDownload = blob;
            } else {
                blobToDownload = rec.blob;
            }
            await performBlobDownload(blobToDownload, state.currentImageId);
            updateStats('downloads');
            showNotification('下载成功', 'fas fa-download');
        } catch (e) {
            console.error('下载图片失败', e);
            showNotification(`下载失败: ${e.message}。请尝试右键另存为`, 'fas fa-exclamation-triangle');
        } finally {
            // [核心修复]：恢复按钮状态
            elements.downloadBtn.disabled = false;
            elements.downloadBtn.innerHTML = originalBtnContent;
        }
    }

    function performBlobDownload(blob, imageId) {
        return new Promise(resolve => {
            const a = document.createElement('a');
            const url = URL.createObjectURL(blob);
            a.href = url;
            const filename = `美女图片_${imageId}.jpg`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                try { URL.revokeObjectURL(url); } catch (e) { }
                resolve();
            }, 150);
        });
    }

    // ----- 历史 -----
    function addToHistory(meta = null) {
        if (!meta) {
            meta = { id: state.currentImageId, url: state.currentImageUrl };
        }
        if (!meta.id) return;
        const existingIndex = state.history.findIndex(item => item.id === meta.id);
        if (existingIndex !== -1) {
            const [existingItem] = state.history.splice(existingIndex, 1);
            state.history.unshift(existingItem);
        } else {
            const historyItem = { id: meta.id, url: meta.url, timestamp: new Date().toLocaleString() };
            state.history.unshift(historyItem);
        }
        state.history = state.history.slice(0, 50);
        localStorage.setItem('history', JSON.stringify(state.history));
        loadHistory();
    }

    async function loadHistory() {
        const container = elements.historyList;
        if (!state.history || state.history.length === 0) {
            container.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 30px 20px;"><i class="fas fa-history" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>暂无历史</div>`;
            return;
        }
        const rows = await Promise.all(state.history.map(async item => {
            const rec = await dbGetImage(item.id);
            let thumbUrl = '';
            if (rec && rec.blob) {
                try { thumbUrl = URL.createObjectURL(rec.blob); } catch (e) { thumbUrl = ''; }
            } else {
                if (item.url) { thumbUrl = item.url; }
            }
            return `<div class="content-item" onclick="loadImageFromHistory('${item.id}');"><img class="content-thumb" src="${thumbUrl}" alt="历史图片" loading="lazy"><div class="content-info">${item.timestamp}</div></div>`;
        }));
        container.innerHTML = rows.join('');
    }

    // ----- 统计 -----
    function updateStats(type, opts = { incrementDirect: true }) {
        switch (type) {
            case 'views':
                if (opts.incrementDirect !== false) state.stats.views++;
                elements.viewCount.textContent = state.stats.views;
                break;
            case 'downloads':
                state.stats.downloads++;
                elements.downloadCount.textContent = state.stats.downloads;
                break;
            case 'shares':
                state.stats.shares++;
                elements.shareCount.textContent = state.stats.shares;
                break;
            case 'favorites':
                elements.favoriteCount.textContent = state.favorites.length;
                break;
        }
        localStorage.setItem('stats', JSON.stringify(state.stats));
    }

    function loadStats() {
        elements.viewCount.textContent = state.stats.views;
        elements.downloadCount.textContent = state.stats.downloads;
        elements.shareCount.textContent = state.stats.shares;
        elements.favoriteCount.textContent = state.favorites.length;
    }

    // ----- 清理 -----
    function clearHistory() {
        if (!confirm('确认清空浏览历史？此操作不可撤销。')) return;
        elements.historyList.querySelectorAll('.content-thumb').forEach(thumb => {
            if (thumb.src.startsWith('blob:')) { try { URL.revokeObjectURL(thumb.src); } catch (e) { } }
        });
        state.history = [];
        localStorage.setItem('history', JSON.stringify(state.history));
        loadHistory();
        showNotification('浏览历史已清空', 'fas fa-history');
    }

    function clearFavorites() {
        if (!confirm('确认清空我的收藏？此操作不可撤销。')) return;
        elements.favoritesList.querySelectorAll('.content-thumb').forEach(thumb => {
            if (thumb.src.startsWith('blob:')) { try { URL.revokeObjectURL(thumb.src); } catch (e) { } }
        });
        state.favorites = [];
        localStorage.setItem('favorites', JSON.stringify(state.favorites));
        loadFavorites();
        updateStats('favorites');
        showNotification('收藏已清空', 'fas fa-heart-broken');
    }

    async function clearCache() {
        if (!confirm('确认清空缓存？清空后本地存储的图片将被删除（收藏项和历史记录仍保留元数据，但缩略图将不可用）。')) return;
        state.isLoadingMainImage = true;
        state.isPreloading = true;
        showLoading();
        elements.preloadIndicator.style.display = 'none';
        await dbClearAllImages();
        if (state.preloadedImage && state.preloadedImage.objUrl) {
            try { URL.revokeObjectURL(state.preloadedImage.objUrl); } catch (e) { }
        }
        state.preloadedImage = null;
        state.isPreloading = false;
        if (currentObjectUrl) {
            try { URL.revokeObjectURL(currentObjectUrl); } catch (e) { }
            currentObjectUrl = null;
        }
        state.currentImageId = '';
        state.currentImageUrl = '';
        localStorage.removeItem('lastImageId');
        elements.image.src = '';
        elements.image.style.display = 'none';
        hideLoading();
        showNotification('缓存已清空，正在加载新图片', 'fas fa-trash');
        await fetchAndDisplayNewImage();
    }

    function clearStats() {
        if (!confirm('确认清空统计数据？此操作不会影响收藏与缓存。')) return;
        state.stats = { views: 0, downloads: 0, shares: 0 };
        localStorage.setItem('stats', JSON.stringify(state.stats));
        loadStats();
        showNotification('统计已清空', 'fas fa-chart-bar');
    }

    // ----- 全局事件 -----
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (elements.fullscreenOverlay.style.display === 'flex') { return; }
        switch (e.code) {
            case 'Space': e.preventDefault(); if (!elements.loadBtn.disabled) loadRandomImage(); break;
            case 'KeyF': e.preventDefault(); if (!elements.favoriteBtn.disabled) toggleFavorite(); break;
            case 'KeyD': e.preventDefault(); if (!elements.downloadBtn.disabled) downloadImage(); break;
            case 'KeyS': e.preventDefault(); if (!elements.shareBtn.disabled) showSharePanel(); break;
            case 'KeyT': e.preventDefault(); toggleTheme(); break;
            case 'Escape': if (elements.sharePanel && elements.sharePanel.classList.contains('active')) { hideSharePanel(); } break;
        }
    });
    document.addEventListener('click', function(e) {
        if (elements.sharePanel && elements.sharePanel.classList.contains('active') && !elements.sharePanel.contains(e.target) && !e.target.closest('.share-btn') && !e.target.closest('#shareBtn')) {
            hideSharePanel();
        }
    });

    // ----- 页面加载后初始化 -----
    window.addEventListener('load', init);

    // 暴露函数给 HTML 事件绑定使用
    window.loadRandomImage = loadRandomImage;
    window.openFullscreen = openFullscreen;
    window.exitFullscreen = exitFullscreen;
    window.toggleFavorite = toggleFavorite;
    window.toggleTheme = toggleTheme;
    window.downloadImage = downloadImage;
    window.showSharePanel = showSharePanel;
    window.hideSharePanel = hideSharePanel;
    window.shareToWeibo = shareToWeibo;
    window.shareToWeixin = shareToWeixin;
    window.shareToQQ = shareToQQ;
    window.copyLink = copyLink;
    window.loadImageFromFavorite = loadImageFromFavorite;
    window.loadImageFromHistory = loadImageFromHistory;
    window.removeFavorite = removeFavorite;
    window.clearHistory = clearHistory;
    window.clearFavorites = clearFavorites;
    window.clearCache = clearCache;
    window.clearStats = clearStats;

</script>
</html>
